/*
 * Leaflet.gl ©2015 Iván Sánchez Ortega
 *
 * "THE BEER-WARE LICENSE":
 * <ivan@sanchezortega.es> wrote this file. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 *
 *
 * Leaflet.gl includes unitbezier (https://github.com/mapbox/unitbezier),
 * distributed under a 2-clause BSD license.
 */

L.Browser.gl=!1;try{var canvas=document.createElement("canvas"),context=canvas.getContext("webgl");context&&"function"==typeof context.getParameter?L.Browser.gl="webgl":(context=canvas.getContext("experimental-webgl"),context&&"function"==typeof context.getParameter&&(L.Browser.gl="experimental-webgl"))}catch(e){}L.Browser.gl&&(L.GlUtil={createProgram:function(t,e,i,r,o){var n=t,a=n.createProgram(),s=n.createShader(n.VERTEX_SHADER),l=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(s,e),n.shaderSource(l,i),n.compileShader(s),n.compileShader(l),!n.getShaderParameter(s,n.COMPILE_STATUS))throw new Error(n.getShaderInfoLog(s));if(!n.getShaderParameter(l,n.COMPILE_STATUS))throw new Error(n.getShaderInfoLog(l));n.attachShader(a,s),n.attachShader(a,l),n.linkProgram(a),a.attributes={},a.uniforms={};var u,h,m;if(r&&r.length)for(u=0;u<r.length;u++){if(m=r[u],h=n.getAttribLocation(a,m),-1===h)throw new Error("Attribute "+m+" not found in shaders");a.attributes[m]=h}if(o&&o.length)for(u=0;u<o.length;u++){if(m=o[u],h=n.getUniformLocation(a,m),-1===h)throw new Error("Uniform "+m+" not found in shaders");a.uniforms[m]=h}return a},initBuffer:function(t,e,i){var r=t,o=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,o),r.bufferData(r.ARRAY_BUFFER,e,i||r.STATIC_DRAW),o},initTexture:function(t,e){var i=t,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.bindTexture(i.TEXTURE_2D,null),r},bindBufferToAttrib:function(t,e,i,r,o){t.bindBuffer(t.ARRAY_BUFFER,e),t.vertexAttribPointer(i,r,o,!1,0,0)},matrixMultiply:function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],h=t[8],m=t[9],f=t[10],c=t[11],g=t[12],d=t[13],_=t[14],x=t[15],p=e[0],v=e[1],T=e[2],y=e[3],L=e[4],C=e[5],R=e[6],A=e[7],E=e[8],S=e[9],P=e[10],w=e[11],b=e[12],G=e[13],U=e[14],B=e[15];return[i*p+r*L+o*E+n*b,i*v+r*C+o*S+n*G,i*T+r*R+o*P+n*U,i*y+r*A+o*w+n*B,a*p+s*L+l*E+u*b,a*v+s*C+l*S+u*G,a*T+s*R+l*P+u*U,a*y+s*A+l*w+u*B,h*p+m*L+f*E+c*b,h*v+m*C+f*S+c*G,h*T+m*R+f*P+c*U,h*y+m*A+f*w+c*B,g*p+d*L+_*E+x*b,g*v+d*C+_*S+x*G,g*T+d*R+_*P+x*U,g*y+d*A+_*w+x*B]},identityMatrix:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},xRotationMatrix:function(t){var e=Math.cos(t),i=Math.sin(t);return[1,0,0,0,0,e,i,0,0,-i,e,0,0,0,0,1]},zRotationMatrix:function(t){var e=Math.cos(t),i=Math.sin(t);return[e,i,0,0,-i,e,0,0,0,0,1,0,0,0,0,1]},translationMatrix:function(t){return[1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1]},scaleMatrix:function(t){return[t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,1]}},L.glUtil={},L.GlUtil.UnitBezier=function(t,e,i,r){this.cx=3*t,this.bx=3*(i-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(r-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=r,this.p2x=i,this.p2y=r},L.GlUtil.UnitBezier.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){"undefined"==typeof e&&(e=1e-6);var i,r,o,n,a;for(o=t,a=0;8>a;a++){if(n=this.sampleCurveX(o)-t,Math.abs(n)<e)return o;var s=this.sampleCurveDerivativeX(o);if(Math.abs(s)<1e-6)break;o-=n/s}if(i=0,r=1,o=t,i>o)return i;if(o>r)return r;for(;r>i;){if(n=this.sampleCurveX(o),Math.abs(n-t)<e)return o;t>n?i=o:r=o,o=.5*(r-i)+i}return o},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}},L.glUtil.unitBezier=function(t,e,i,r){return new L.GlUtil.UnitBezier(t,e,i,r)},function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this),this.on("move moveend",function(){this._glView.center=this.options.crs.project(this.getCenter());var t=this.options.crs.project(this.containerPointToLatLng(this.getSize()));this._glView.halfSize=t.subtract(this._glView.center),this.glRenderOnce()},this)}})}(),function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this),this.on("zoomanim",this._onGlZoomAnimationStart,this),this.on("zoomend",this._onGlZoomAnimationEnd,this)},_glZoomAnimationDuration:250,_onGlZoomAnimationStart:function(t){var e=this.options.crs.project(this.getCenter()),i=this.options.crs.project(this.containerPointToLatLng(this.getSize())),r=i.subtract(e),o=this.options.crs.project(this._animateToCenter),n=r.divideBy(this.getZoomScale(this._animateToZoom,this._zoom)),a=e.x,s=e.y,l=o.x,u=o.y,h=r.x,m=r.y,f=n.x,c=n.y,g=(l*h-a*f)/(h-f),d=(u*m-s*c)/(m-c),_=new L.Point(g,d),x=this.latLngToContainerPoint(this.options.crs.unproject(_)),p=this.getSize(),v=new L.Point(x.x/p.x,x.y/p.y).subtract(new L.Point(.5,.5)).multiplyBy(2),T=this._container.querySelector(".leaflet-proxy.leaflet-zoom-animated").style.transform;this._glZoomAnimation={startHalfSize:r,fixedCRSCoords:_,relativeContainerPoint:v,until:-1,bezier:L.glUtil.unitBezier(0,0,.25,1),transformCSS:T,scale:this.getZoomScale(this._animateToZoom,this._zoom)},this.on("glPrepareFrame",this._onGlZoomAnimationFrame),this.glRenderUntil(this._glZoomAnimationDuration)},_onGlZoomAnimationEnd:function(t){this._glZoomAnimation=null,this.off("glPrepareFrame",this._onGlZoomAnimationFrame)},_onGlZoomAnimationFrame:function(){var t=null;if(this._glZoomAnimation){if(-1===this._glZoomAnimation.until){var e=this._container.querySelector(".leaflet-proxy.leaflet-zoom-animated").style.transform;if(e===this._glZoomAnimation.transformCSS)return;this._glZoomAnimation.until=performance.now()+this._glZoomAnimationDuration,this.glRenderUntil(this._glZoomAnimationDuration)}var i=this._glZoomAnimation,r=Math.min(1-(i.until-performance.now())/this._glZoomAnimationDuration,1),o=i.bezier.solve(r),n=1+o*(i.scale-1);this._glView.halfSize=t=i.startHalfSize.divideBy(n);var a=new L.Point(t.x*i.relativeContainerPoint.x,t.y*i.relativeContainerPoint.y);this._glView.center=i.fixedCRSCoords.subtract(a)}}})}(),function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this);this.getSize();this._glCanvas=L.DomUtil.create("canvas","leaflet-webgl",this._container);var e=this._gl=this._glCanvas.getContext(L.Browser.gl,{premultipliedAlpha:!1});this._glPrograms=[],this._glLayers={},this._glView={},this._glResizeCanvas(),e.clearColor(.5,.5,.5,0),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)},registerGlProgram:function(t,e,i,r,o,n){if(!(t in this._glLayers)){this._glLayers[t]=[];var a=this._gl;if(!a)throw Error("A layer tried to register a WebGL program before the map initialized its layout and WebGL context.");var s="uniform mat4 uTransformMatrix;vec4 crs2clipspace(vec4 coords){return coords=uTransformMatrix*coords;}\n",l=L.GlUtil.createProgram(a,s+i,r,o,["uTransformMatrix"].concat(n));l.priority=e,l.name=t;for(var u in l.attributes)a.enableVertexAttribArray(l.attributes[u]);this._glPrograms.push(l),this._glPrograms.sort(function(t,e){return t.priority-e.priority})}},attachLayerToGlProgram:function(t,e){if(!(e in this._glLayers))throw new Error("Layer tried to attach to a non-existing GL program");return this._glLayers[e].push(t),this},detachLayerFromGlProgram:function(t,e){if(!(e in this._glLayers))throw new Error("Layer tried to detach from a non-existing GL program");return this._glLayers[e].splice(this._glLayers[e].indexOf(t),1),this},getGlContext:function(){return this._gl},glRenderUntil:function(t){return this._glEndTime?this._glEndTime=Math.max(performance.now()+t,this._glEndTime):(this.fire("glRenderStart",{now:performance.now()}),this._glEndTime=performance.now()+t,L.Util.requestAnimFrame(this._glRender,this)),this},glRenderOnce:function(){return this._glEndTime||(this._glEndTime=1,L.Util.requestAnimFrame(this._glRender,this)),this},_glRender:function(){var t=performance.now();this._glEndTime&&this._glEndTime>t?L.Util.requestAnimFrame(this._glRender,this):(this._glEndTime=null,this.fire("glRenderEnd",{now:performance.now()}));var e=this._glView,i=L.GlUtil.identityMatrix();i=L.GlUtil.matrixMultiply(i,L.GlUtil.translationMatrix([-e.center.x,-e.center.y,0])),i=L.GlUtil.matrixMultiply(i,L.GlUtil.scaleMatrix([1,-1,-1])),i=L.GlUtil.matrixMultiply(i,L.GlUtil.zRotationMatrix(this._bearing||0)),i=L.GlUtil.matrixMultiply(i,L.GlUtil.scaleMatrix([1/e.halfSize.x,-1/e.halfSize.y,1])),i=L.GlUtil.matrixMultiply(i,L.GlUtil.xRotationMatrix(this._tilt||0)),i=L.GlUtil.matrixMultiply(i,L.GlUtil.scaleMatrix([1,-1,-.1]));var r=this._gl;r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.polygonOffset(0,1),this.fire("glPrepareFrame");var o;for(var n in this._glPrograms){var a=this._glPrograms[n],s=a.name;if(this._glLayers[s].length){r.useProgram(a),r.uniformMatrix4fv(a.uniforms.uTransformMatrix,!1,i);for(o in this._glLayers[s])this._glLayers[s][o].glRender(a)}}var l=performance.now(),u=l-t,h=1e3/(l-this._glLastFrameTimestamp);this.fire("glRenderFrame",{now:l,frameTime:u,fps:h}),this._glLastFrameTimestamp=l},invalidateSize:function(e){t.invalidateSize.call(this,e),this._glResizeCanvas(),this.glRenderOnce()},_glResizeCanvas:function(){var t=this.getSize();this._glCanvas.style.width=t.x+"px",this._glCanvas.style.height=t.y+"px",this._glCanvas.width=t.x,this._glCanvas.height=t.y,this._gl.viewportWidth=this._glCanvas.width,this._gl.viewportHeight=this._glCanvas.height}})}(),function(){var t=L.extend({},L.TileLayer.prototype);L.TileLayer.addInitHook(function(){this.options.crossOrigin=!0}),L.TileLayer.include({onAdd:function(e){t.onAdd.call(this,e),e.registerGlProgram("tile",1,"precision mediump float;attribute vec3 aCRSCoords;attribute vec2 aTextureCoords;varying vec2 vTextureCoords;attribute float aAge;varying float vAge;uniform float uTileZoom;void main(){gl_Position=crs2clipspace(vec4(aCRSCoords.x,aCRSCoords.y,0.,1.));gl_Position.z+=abs(aCRSCoords.z-uTileZoom)*1e-5;vTextureCoords=aTextureCoords;vAge=aAge;}","precision mediump float;varying vec2 vTextureCoords;varying float vAge;uniform sampler2D uTexture;uniform float uNow;\n#define fadeInTime 200.0\nvoid main(){lowp vec4 textureColor=texture2D(uTexture,vec2(vTextureCoords.s,vTextureCoords.t));textureColor.a*=clamp((uNow-vAge)/fadeInTime,0.,1.);gl_FragColor=textureColor;}",["aCRSCoords","aTextureCoords","aAge"],["uNow","uTexture","uTileZoom"]),e.attachLayerToGlProgram(this,"tile")},onRemove:function(e){t.onRemove.call(this,e),e.detachLayerFromGlProgram(this,"tile")},_initContainer:function(){},_tileReady:function(t,e,i){if(this._map){e&&this.fire("tileerror",{error:e,tile:i,coords:t});var r=this._tileCoordsToKey(t);if(i=this._tiles[r]){i.glData=new Float32Array(24),i.age=performance.now();var o=this._tileCoordsToProjectedBounds(t),n=i.coords.z;i.glData.set([o.min.x,o.min.y,n,0,1,i.age,o.max.x,o.min.y,n,1,1,i.age,o.min.x,o.max.y,n,0,0,i.age,o.max.x,o.max.y,n,1,0,i.age]),i.texture=L.GlUtil.initTexture(this._map.getGlContext(),i.el),this.fire("tileload",{tile:i.el,coords:t}),this._noTilesToLoad()&&(this._loading=!1,this.fire("load")),this._map.glRenderUntil(500)}}},_tileCoordsToProjectedBounds:function(t){var e=this._map,i=e.options.crs,r=i.transformation,o=this._getTileSize(),n=i.scale(t.z),a=t.multiplyBy(o),s=a.add([o,o]);return a=r.untransform(a,n),s=r.untransform(s,n),new L.Bounds(a,s)},_removeTile:function(t){var e=this._tiles[t];e&&(window.setTimeout(function(){this._map.getGlContext().deleteTexture(e.texture),delete this._tiles[t]}.bind(this),500),this.fire("tileunload",{tile:e.el,coords:this._keyToTileCoords(t)}))},_invalidateGlVertexBuffer:function(){this._map.getGlContext().destroyBuffer(this._glVertexBuffer),this._glVertexBuffer=null},_getGlBuffers:function(){if(this._glBuffers)return this._glBuffers;var t=Object.keys(this._tiles).length,e=this._map.getGlContext(),i=24,r=new Float32Array(t*i),o=0,n=[];for(var a in this._tiles){var s=this._tiles[a];s.age&&(r.set(s.glData,o*i),n[o]=s.texture,o++)}return{vertices:L.GlUtil.initBuffer(e,r,e.DYNAMIC_DRAW),textures:n,length:o}},glRender:function(t,e){var i=this._map.getGlContext(),r=this._getGlBuffers();i.uniform1f(t.uniforms.uTileZoom,this._tileZoom),i.uniform1f(t.uniforms.uNow,performance.now());var o=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,r.vertices),i.vertexAttribPointer(o.aCRSCoords,3,i.FLOAT,!1,24,0),i.vertexAttribPointer(o.aTextureCoords,2,i.FLOAT,!1,24,12),i.vertexAttribPointer(o.aAge,1,i.FLOAT,!1,24,20);for(var n=0;n<r.length;n++)i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,r.textures[n]),i.uniform1i(t.uniforms.uTexture,0),i.drawArrays(i.TRIANGLE_STRIP,4*n,4)}})}(),function(){var t=L.extend({},L.ImageOverlay.prototype);L.ImageOverlay.addInitHook(function(){this.options.crossOrigin=!0}),L.ImageOverlay.include({onAdd:function(t){t.registerGlProgram("imageoverlay",2,"precision mediump float;attribute vec3 aCRSCoords;attribute vec2 aTextureCoords;varying vec2 vTextureCoords;void main(){gl_Position=crs2clipspace(vec4(aCRSCoords.x,aCRSCoords.y,-.2,1.));vTextureCoords=aTextureCoords;}","precision mediump float;varying vec2 vTextureCoords;uniform sampler2D uTexture;uniform float uOpacity;void main(){lowp vec4 textureColor=texture2D(uTexture,vec2(vTextureCoords.s,vTextureCoords.t));textureColor.a*=uOpacity;if(textureColor.a<.01){discard;}else{gl_FragColor=textureColor;}}",["aCRSCoords","aTextureCoords"],["uTexture","uOpacity"]),this._initImage(),this.on("load",this._onLoad,this)},onRemove:function(e){if(t.onRemove.call(this,e),this._glBuffer){var i=e.getGlContext();i.destroyBuffer(this._glVertexBuffer),i.deleteTexture(this._texture)}e.detachLayerFromGlProgram(this,"imageoverlay")},_onLoad:function(t){this._glData=new Float32Array(20),this._age=performance.now();var e=this._map.options.crs.project(this._bounds.getNorthWest()),i=this._map.options.crs.project(this._bounds.getSouthEast());this._glData.set([i.x,e.y,0,1,0,e.x,e.y,0,0,0,i.x,i.y,0,1,1,e.x,i.y,0,0,1]);var r=this._map.getGlContext();this._glBuffer=L.GlUtil.initBuffer(r,this._glData,r.STATIC_DRAW),this._texture=L.GlUtil.initTexture(this._map.getGlContext(),this._image),map.attachLayerToGlProgram(this,"imageoverlay")},glRender:function(t,e){var i=this._map.getGlContext(),r=this.options.opacity*Math.min((performance.now()-this._age)/200,1);i.uniform1f(t.uniforms.uOpacity,r);var o=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,this._glBuffer),i.vertexAttribPointer(o.aCRSCoords,3,i.FLOAT,!1,20,0),i.vertexAttribPointer(o.aTextureCoords,2,i.FLOAT,!1,20,12),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._texture),i.uniform1i(t.uniforms.uTexture,0),i.drawArrays(i.TRIANGLE_STRIP,0,4)}})}(),L.Sprite=L.Layer.extend({options:{opacity:1},initialize:function(t,e,i){L.setOptions(this,i),this._latLng=L.latLng(t),this._url=e},onAdd:function(t){t.registerGlProgram("sprite",3,"precision mediump float;attribute vec3 aCRSCoords;attribute vec2 aPixelOffset;attribute vec2 aTextureCoords;varying vec2 vTextureCoords;uniform vec2 uCanvasSize;void main(){vec4 pos=crs2clipspace(vec4(aCRSCoords.x,aCRSCoords.y,aCRSCoords.z,1.));pos.x+=2.*aPixelOffset.x/uCanvasSize.x;pos.y+=2.*aPixelOffset.y/uCanvasSize.y;gl_Position=pos;vTextureCoords=aTextureCoords;}","precision mediump float;varying vec2 vTextureCoords;uniform sampler2D uTexture;uniform float uOpacity;void main(){lowp vec4 textureColor=texture2D(uTexture,vec2(vTextureCoords.s,vTextureCoords.t));textureColor.a*=uOpacity;gl_FragColor=textureColor;}",["aCRSCoords","aTextureCoords","aPixelOffset"],["uTexture","uOpacity","uCanvasSize"]),this._image=L.DomUtil.create("img"),this._image.onload=L.bind(this.fire,this,"load"),this._image.onerror=L.bind(this.fire,this,"error"),this.on("load",this._onLoad,this),this.on("error",function(t){console.error(t)},this),this._image.src=this._url},onRemove:function(t){if(imageOverlayProto.onRemove.call(this,t),this._glBuffer){var e=t.getGlContext();e.destroyBuffer(this._glVertexBuffer),e.deleteTexture(this._texture)}t.detachLayerFromGlProgram(this,"sprite")},_onLoad:function(t){this.options.spriteSize||(this.options.spriteSize=new L.Point(t.originalTarget.width,t.originalTarget.height)),this.options.spriteAnchor||(this.options.spriteAnchor=this.options.spriteSize.divideBy(2)),this._glData=new Float32Array(28),this._age=performance.now();var e=this.options.spriteSize,i=this.options.spriteAnchor,r=i.multiplyBy(-1),o=e.subtract(i),n=this._map.options.crs.project(this._latLng);this._glData.set([n.x,n.y,0,r.x,r.y,1,1,n.x,n.y,0,o.x,r.y,0,1,n.x,n.y,0,r.x,o.y,1,0,n.x,n.y,0,o.x,o.y,0,0]),console.log(this._glData);var a=this._map.getGlContext();this._glBuffer=L.GlUtil.initBuffer(a,this._glData,a.STATIC_DRAW),this._texture=L.GlUtil.initTexture(this._map.getGlContext(),this._image),map.attachLayerToGlProgram(this,"sprite"),map.glRenderUntil(200)},glRender:function(t,e){var i=this._map.getGlContext(),r=(this.options.opacity*Math.min((performance.now()-this._age)/200,1),this._map.getSize());i.uniform1f(t.uniforms.uOpacity,1),i.uniform2f(t.uniforms.uCanvasSize,r.x,r.y);var o=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,this._glBuffer),i.vertexAttribPointer(o.aCRSCoords,3,i.FLOAT,!1,28,0),i.vertexAttribPointer(o.aPixelOffset,2,i.FLOAT,!1,28,12),i.vertexAttribPointer(o.aTextureCoords,2,i.FLOAT,!1,28,20),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._texture),i.uniform1i(t.uniforms.uTexture,0),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}),L.sprite=function(t,e,i){return new L.Sprite(t,e,i)});
//# sourceMappingURL=Leaflet.gl.min.js.map
